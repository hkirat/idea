<head>
	<script src="https://simplewebrtc.com/latest-v2.js"></script>
    <title>Hello, WebVR! - A-Frame</title>
    <meta name="description" content="Hello, WebVR! - A-Frame">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="https://aframe.io/releases/0.6.0/aframe.min.js"></script>
    <script>
		var webrtc = new SimpleWebRTC({
		  // the id/element dom element that will hold "our" video
		  localVideoEl: 'localVideo',
		  // the id/element dom element that will hold remote videos
		  remoteVideosEl: '',
		  // immediately ask for camera access
		  autoRequestMedia: true
		});

		webrtc.on('readyToCall', function () {
		  console.log("asd");
		  webrtc.joinRoom('Merasdcariadss');
			webrtc.connection.on("message", function(msg) {
				if(msg.type === "position") {
					changePos(msg.payload);
				}
			});
		});
		function changePos(val) {
			console.log("received");
			if(val != $("a-camera").attr('position')) {
				console.log("position changed to " + val);
				$("a-camera").attr('position', (val));
			}
		}

		var prev = " ";
		var main = function () {
		  var val = "";
		  if(!$("a-camera") || !webrtc) {
		    requestAnimationFrame(main);
		    return;
		  }
		  if($("a-camera").attr('position') == prev) {
		    requestAnimationFrame(main);
		    return;
		  }
		  prev = $("a-camera").attr('position');
		  var pos = $("a-camera").attr('position');
		  if(!pos) {
		    requestAnimationFrame(main);
		    return;
		  }
		  if(!pos.x) {
		    pos.x = 0;
		  }
		  if(!pos.y) {
		    pos.y = 0;
		  }
		  if(!pos.z) {
		    pos.z = 0;
		  }
		  val = val + pos.x + " " + pos.y + " " + pos.z;
		  console.log("sent " + val);
		  webrtc.sendToAll("position", val);      
		  requestAnimationFrame(main);
		};
		var w = window;
		requestAnimationFrame = w.requestAnimationFrame || w.webkitRequestAnimationFrame || w.msRequestAnimationFrame || w.mozRequestAnimationFrame;
		var then = Date.now();
		main();

    </script>
</head>

<body>
    <a-scene>
     <a-entity position="0 0 0">
	    <a-camera look-controls wasd-controls id="cam"></a-camera>
	  </a-entity>
      <a-box position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
      <a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
      <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder>
      <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>
</body>